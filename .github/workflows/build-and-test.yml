name: Build and Test Docker Images

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/expense-tracker

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Test - Start services
        run: |
          # Create .env file for testing
          cat > .env <<EOF
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=test_password
          POSTGRES_DB=expensetracker
          DATABASE_URL=postgresql://postgres:test_password@db:5432/expensetracker
          JWT_SECRET=test-jwt-secret-for-ci-only-do-not-use-in-production
          NODE_ENV=production
          FRONTEND_URL=http://localhost:3333
          EOF

          # Start services
          docker-compose up -d

          # Wait for services to be healthy
          echo "Waiting for services to be healthy..."
          timeout=120
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            backend_health=$(docker inspect --format='{{.State.Health.Status}}' $(docker-compose ps -q backend) 2>/dev/null || echo "starting")
            frontend_health=$(docker inspect --format='{{.State.Health.Status}}' $(docker-compose ps -q frontend) 2>/dev/null || echo "starting")
            db_health=$(docker inspect --format='{{.State.Health.Status}}' $(docker-compose ps -q db) 2>/dev/null || echo "starting")

            echo "Backend: $backend_health, Frontend: $frontend_health, DB: $db_health"

            if [ "$backend_health" = "healthy" ] && [ "$frontend_health" = "healthy" ] && [ "$db_health" = "healthy" ]; then
              echo "All services are healthy!"
              break
            fi

            sleep 5
            elapsed=$((elapsed + 5))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "Services failed to become healthy in time"
            docker-compose logs
            exit 1
          fi

      - name: Test - Health checks
        run: |
          # Test backend health endpoint
          backend_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health)
          if [ "$backend_response" != "200" ]; then
            echo "Backend health check failed with status $backend_response"
            docker-compose logs backend
            exit 1
          fi
          echo "✓ Backend health check passed"

          # Test frontend
          frontend_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3333)
          if [ "$frontend_response" != "200" ]; then
            echo "Frontend check failed with status $frontend_response"
            docker-compose logs frontend
            exit 1
          fi
          echo "✓ Frontend check passed"

          # Test database connection
          docker-compose exec -T db pg_isready -U postgres
          if [ $? -ne 0 ]; then
            echo "Database check failed"
            docker-compose logs db
            exit 1
          fi
          echo "✓ Database check passed"

      - name: Test - API endpoints
        run: |
          # Test that API returns proper error for unauthorized access
          api_response=$(curl -s -w "\n%{http_code}" http://localhost:3001/api/properties)
          status_code=$(echo "$api_response" | tail -n1)

          if [ "$status_code" != "401" ]; then
            echo "Expected 401 for unauthorized API access, got $status_code"
            exit 1
          fi
          echo "✓ API authentication check passed"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker-compose logs
          echo "=== Container Status ==="
          docker-compose ps

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v

  build-summary:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Summary
        run: |
          echo "✅ All Docker images built and tested successfully!"
          echo "Images are available at: ghcr.io/${{ github.repository_owner }}/expense-tracker-backend:latest"
          echo "                        ghcr.io/${{ github.repository_owner }}/expense-tracker-frontend:latest"
